# 最適化戦略 (Optimization Strategy)

## 1. 概要
本ドキュメントでは、RogueBにおけるシステムのパフォーマンスを維持し、低遅延なゲーム体験を提供するための最適化手法を定義します。

## 2. 通信・処理の最適化

### 2.1 リアクティブスタックの活用
- **概要**: Spring WebFlux と Project Reactor を使用し、すべての I/O 操作（DB アクセス、サービス間通信）を非ブロッキングで実行します。
- **効果**: スレッド数の節約と、高負荷時におけるスループットの維持。
- **注意点**: 処理チェーン内でのブロッキング操作（Thread.sleep や同期的な I/O）の徹底的な排除。

### 2.2 フィールド情報の差分更新
- **概要**: プレイヤー周辺の視界情報（DisplayData）を送信する際、全データを送るのではなく、前回からの差分のみを送信する仕組み（将来計画）。
- **現状**: 現在は `FieldsService` にて 20 秒間隔、または即時要求時に全周辺データを送信。

## 3. データベース（MongoDB）の最適化

### 3.1 インデックス設計
- **座標検索**: `floorDomain.tiles` や `objectHistoryDomain` における位置検索を高速化するため、適切なインデックス（2DSphere 等の検討）を設定します。
- **頻出クエリ**: `userId`, `playerId`, `parentId` などの頻繁に検索条件となるフィールドへのインデックス付与。

### 3.2 履歴データの管理
- **ObjectHistory**: インスタンスの状態変更のたびにレコードが増えるため、古い履歴のアーカイブや、スナップショットによる最新状態の高速取得を検討します。

## 4. 計算量の削減

### 4.1 視界判定（FOV）の最適化
- **概要**: 壁による視線の遮蔽計算において、計算範囲をプレイヤー周辺の一定半径（例: 8マス）に制限します。
- **アルゴリズム**: シンプルなレイキャスティング、または Shadow Casting アルゴリズムの採用。

### 4.2 キャッシング
- **マスタデータ**: 武器や防具の基本スペックなどの不変データは、各マイクロサービスのメモリ上にキャッシュし、DB への問い合わせを最小限にします。

## 5. リソース管理

### 5.1 オブジェクトプーリング
- **概要**: 頻繁に生成・破棄される小さなオブジェクト（座標計算用のインスタンス等）について、再利用を検討します。
- **Java 21 の活用**: Value Objects (Records) の積極的な使用により、ヒープへの負荷を軽減します。
