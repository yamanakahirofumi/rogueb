# 機能仕様書 (Functional Specification)

## 1. システム構成と責務
RogueBは、クライアント・サーバー構成のアプリケーションにおけるサーバー側（バックエンド）の実装です。

### 1.1 本リポジトリの役割 (バックエンド)
このリポジトリは、ゲームの**核となるロジック、データ、および状態管理**を担当します。
- ダンジョンの生成、モンスターの配置、戦闘の計算
- プレイヤーの座標、HP、アイテムなどのステータス管理
- マルチプレイヤー間の同期、リアルタイムの干渉処理
- 永続データの保存
- クライアント（フロントエンド）へのAPIおよびSSEによる情報提供

### 1.2 クライアントの役割 (フロントエンド)
ゲームのUIおよび表示に関する処理は、フロントエンド側で処理されます。
- ユーザーへの情報の表示、操作の受け付け
- サーバー（バックエンド）との通信（API, SSE）
- クライアント側での一部の演出

---

## 2. ゲームコンセプト
RogueBは、**「探索と収集」**および**「構築と運営」**を主軸とした、非対称マルチプレイヤー・ローグライクゲームのバックエンドエンジンです。
プレイヤーはランダムに生成されるダンジョンで資材を確保し、管理者はその資材を用いて独自のダンジョンを構築・運営します。

### 2.1 二つのダンジョン形式
本ゲームには、役割の異なる二種類のダンジョンが存在します。

| 形式 | 名称 | 主な目的 | 生成ルール |
| :--- | :--- | :--- | :--- |
| **ランダム生成** | フロンティア（仮） | 資源（モンスター、アイテム、建築資材）の調達 | 潜るたびにランダムに自動生成される |
| **ユーザーデザイン** | マイ・ダンジョン（仮） | 他のプレイヤーへの提供、拠点の防衛、報酬の獲得 | 管理者が手動でモンスターやトラップ、施設を配置する |

### 2.2 ゲームサイクル
1.  **探索 (Explore)**: ランダムダンジョンに挑み、野生のモンスターを捕獲したり、資材や装備を獲得する。
2.  **収集・育成 (Collect & Breed)**: 持ち帰ったモンスターを飼育し、卵を産ませて新たなモンスターを増やす。
3.  **構築 (Build)**: 自分のダンジョンをデザインし、育成したモンスターを配置したりショップを設置したりする。
4.  **公開 (Publish)**: 他のプレイヤーが自分のダンジョンを攻略しに来る。

---

## 3. モンスターシステム
管理者のダンジョンを構成する中心的な要素です。

### 3.1 モンスターの獲得
モンスターは以下の方法で獲得できます。
- **捕獲**: ランダムダンジョンに出現する野生のモンスターに対し、「捕獲用アイテム」を使用して仲間にする。
- **孵化**: 拠点（管理者エリア）で「卵」を孵化させる。

### 3.2 繁殖と卵
- **卵の入手**: すでに捕獲・所持しているモンスターから卵を取得できます。
- これにより、強力な個体を増やしたり、ダンジョンの守りを固めたりすることが可能です。

---

## 4. デスペナルティの設定
本ゲームの最大の特徴の一つとして、**「死のルール」を管理者が設定可能**である点が挙げられます。管理者は自分の支配する世界（ダンジョン）の性質に合わせて、以下のペナルティを組み合わせて設定できます。

### 4.1 ペナルティのバリエーション
- **アイテム没収**:
    - 全アイテム没収
    - ランダムで数個没収
    - 没収なし
- **ゴールド喪失**:
    - 全額喪失
    - 固定額の喪失
    - 所持金の一定パーセントを喪失
- **ステータスリセット**:
    - レベルが 1 に戻る
    - 経験値が一定量減少する
    - 減少なし

### 4.2 設定の意図
管理者は、ダンジョンの難易度や「得られる報酬」とのバランスを考えて、これらのルールを決定します。例えば、非常に過酷なルールが設定されたダンジョンは、その分クリア時の報酬が豪華になる、といった設計が想定されます。

---

## 5. 経済システムと管理者メリット
管理者とプレイヤーの間には、リスクとリターンに基づいた経済関係が存在します。

### 5.1 管理者の利益（略奪と収集）
- **デスペナルティによる収益**: プレイヤーがダンジョン内で死亡した際、設定されたルールに基づき没収されたアイテムやゴールドは、**そのまま管理者の所有物**となります。
- これにより、管理者は「より多くのプレイヤーを惹きつけ、かつ撃破する」というモチベーションを持ちます。

### 5.2 ダンジョンの運営
- **入場料の設定**: (検討中) 管理者はダンジョンへの入場料を徴収できる。
- **クリア報酬**: (検討中) 管理者はプレイヤーを誘い込むために、自身の所持品からクリア報酬を設定することができる。

### 5.3 動的経済システムとショップ経営
本ゲームの世界（サーバー）内では、アイテムの希少性と管理者の販売戦略が経済に直接影響します。

- **世界内存在上限（サーキュレーション制限）**:
    - 特定の強力なアイテムや貴重な素材には、**「その世界（サーバー）内に同時に存在できる最大数」**が設定されています。
    - 上限に達している場合、ランダムダンジョンでのドロップや、モンスターからの取得が制限されます。
- **需要と供給に基づく基本価格の算出**:
    - 全てのアイテムには、その世界内の流通量（在庫数）に応じた「基本市場価格」が自動計算されます。
    - 流通量が少ない（希少な）アイテムほど基本価格は高騰し、流通量が増えるほど下落します。
- **管理者のショップ経営**:
    - 管理者は自分のダンジョン内にショップ（アイテム屋）を設置し、経営することができます。
    - **リアルタイム商品選定**: 販売するアイテムの種類を、手持ちの在庫からリアルタイムに選択可能です（特に流通量の多い消耗品などが主な対象）。
    - **リアルタイム価格決定**: 管理者はアイテムの販売価格を、基本市場価格を参考にしつつ、**自身の判断でリアルタイムに決定・変更**できます。
    - **戦略的な価格設定**: 基本価格より安くしてプレイヤーを誘い込む、あるいは独占的なアイテムを非常に高価に売る、といった戦略的な経済活動が可能です。
- **世界間移動による影響**:
    - 信頼されたサーバーから外部のアイテムが持ち込まれた場合も、その世界内の流通カウントに加算されます。
    - これにより、他サーバーからの「輸入」によって自サーバーの物価をコントロールする、といった高度な経済戦略が可能になります。

---

## 5. マルチプレイとリアルタイム性
本作はリアルタイム制を採用しており、時間の経過が戦略に影響します。

### 5.1 攻略と干渉
- **ハイブリッド型の挑戦**: 事前配置されたダンジョンにプレイヤーが挑みますが、管理者がリアルタイムで介入することも可能です。
- **リアルタイム介入**: 管理者は攻略中のプレイヤーに対し、**「増援の召喚」**や**「状況に応じたコマンド」**などで直接的に妨害・干渉できます。

---

## 6. プレイヤーの役割とPKシステム
本作において、管理者とプレイヤーの境界は流動的です。

### 6.1 役割の両立
- 全てのユーザーは、自身の世界を管理する**「管理者」**としての側面と、他の世界やランダムダンジョンを探索する**「プレイヤー」**としての側面の両方を持ちます。

### 6.2 PK（プレイヤーキル）とモンスター化
- **PKの概念**: 他のプレイヤーの探索を直接的に妨害する要素としてPKが存在します。
- **モンスターとしての参戦**: プレイヤーは特定の条件下で、**「モンスターの一種」**として他のプレイヤーのダンジョンに介入（乱入）し、直接的にそのプレイヤーを排除することが可能です。
- これにより、従来のNPCモンスターにはない、高度な戦術的駆け引きが発生します。

---

## 7. 世界間連携とトラストネットワーク
本作のサーバー側アプリケーションは、複数の管理者が個別に立ち上げることが可能な分散型構造を想定しています。

### 7.1 マルチサーバー構成
- 各管理者は独自のサーバーを運営し、それぞれの「世界」を保持します。
- プレイヤーは特定のサーバーに所属してキャラクターを作成します。

### 7.2 信頼関係（トラスト）の構築
- 異なるサーバーの管理者同士が、相互に「信頼関係」を結ぶことができます。
- 信頼関係が結ばれたサーバー間では、データの相互利用や移動が可能になります。
- **信頼関係の設定オプション**: 接続するサーバーごとに、以下のポリシーを個別に設定可能です。
    - **アイテム持ち込み設定**:
        - **双方向可能**: 互いのサーバー間で自由にアイテムを持ち込み・持ち出しができる。
        - **片方向のみ**: 一方のサーバーからのみ持ち込みを許可し、逆方向は制限する。
        - **移動不可**: キャラクターの移動は許可するが、アイテムの持ち込みは一切禁止する。
    - **レベル（経験値）共有設定**:
        - **レベル共有**: 信頼するサーバー間ですべての経験値・レベルを完全に同期する。
        - **レベル引き継ぐ**: 移動時点のレベルをコピーして開始する。移動後の成長は各サーバーで独立する。
        - **新たに1から始める**: キャラクターの外見や名前などは引き継ぐが、レベルは 1 にリセットされた状態で開始する。

### 7.3 クロスワールド・マイグレーション
- **キャラクターの持ち出し**: 信頼関係の設定に基づき、別の世界へ自分の育てたプレイヤーキャラクターを連れて行くことができます。
- **同期項目**: レベル、ステータス、所持アイテム、モンスターなどが、設定された信頼ポリシーに応じて反映されます。
- **未知のアイテムの持ち込み**: 移動先のサーバーに存在しない（定義されていない）アイテムであっても、元のサーバーからの情報に基づき、そのまま持ち込んで使用することが可能です。
    - **データ継承**: アイテムの名称、説明、外見（スプライト情報）、効果パラメータなどのメタデータ一式をキャラクターデータと共に転送します。
    - **動作保証**: 基本的なアイテムカテゴリ（消費アイテム、装備品など）の振る舞いは標準化されており、未知のアイテムでも移動先サーバーのロジックで動作するように設計されます。
- **不正防止**: サーバー間でのデータ改ざんを防ぐための署名検証や、信頼レベルに応じた制限機能（例：強力すぎるアイテムの持ち込み制限など）の実装を想定します。

---

## 8. 開発・整理における今後の課題
- クライアント側（フロントエンド）との詳細なインターフェース設計
- 各マイクロサービス間（Dungeon, World, Objects等）の連携ロジックの具体化
- 管理者とプレイヤー（またはPK）のリアルタイム同期の通信プロトコル（SSE/WebSocket等）
- モンスター化の条件と制限（バランス調整・サーバー負荷考慮）
- PK時の報酬とペナルティの精査

---
