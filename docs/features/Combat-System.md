# 戦闘システム (Combat System)

## 1. 概要
本ドキュメントは、RogueBにおける戦闘システムの基本仕様を定義します。プレイヤーがダンジョン内でモンスターや他のプレイヤー（PK）と交戦する際のメカニズム、ダメージ計算、および状態異常について記述します。

## 2. 戦闘アクション
プレイヤーおよびエネミーは、自身のターンにおいて以下の戦闘アクションを選択できます。

### 2.1 通常攻撃 (Normal Attack)
- 隣接する 8 方向のいずれかに対して物理攻撃を行います。
- 装備している武器の性能に基づきダメージを算出します。

### 2.2 遠距離攻撃 (Ranged Attack)
- 矢や投擲アイテム、杖の魔法弾などを使用して、離れた地点の対象を攻撃します。
- 飛翔体は壁や他のエンティティに衝突するまで直進します。

### 2.3 スキル・魔法 (Skill & Magic)
- スタミナや MP（導入検討中）を消費して、特殊な効果を発動します。
- 範囲攻撃、自己バフ、デバフ付与などが含まれます。

## 3. ダメージ計算
ダメージの算出には以下の基本式を用います。

### 3.1 物理ダメージ
`ダメージ = (攻撃力 * 乱数係数) - (防御力 / 2)`
- **乱数係数**: 0.9 〜 1.1 の範囲で変動します。
- 算出結果が 1 未満の場合は、最低ダメージとして 1 が適用されます。

### 3.2 クリティカルヒット
- 一定の確率で発生し、最終ダメージを 1.5 倍にします。

## 4. ターン制とリアルタイム性の融合
本作は基本的にはターン制（自分が動くと世界が動く）ですが、以下のリアルタイム要素を考慮します。

- **行動間隔 (Action Interval)**: `PlayerDto` の `actionInterval` に基づき、次の行動が可能になるまでの待機時間が決定されます。
- **管理者の介入**: [機能仕様書](Functional-Specification.md) にある通り、管理者はプレイヤーの攻略中にリアルタイムで増援を送るなどの干渉が可能です。

## 5. 状態異常 (Status Effects)
戦闘を有利・不利に進めるための状態異常を定義します。

| 名称 | 効果 | 解除条件 |
| :--- | :--- | :--- |
| **毒** | 一定歩数ごとにダメージを受ける | 自然治癒（時間経過）または薬草 |
| **混乱** | 移動や攻撃の方向がランダムになる | 自然治癒 |
| **麻痺** | 一定確率で行動に失敗する | 自然治癒 |
| **睡眠** | 行動不能になる。ダメージを受けると解除される | 自然治癒または被ダメージ |
| **封印** | 魔法やスキル、アイテムの使用が制限される | 自然治癒または専用アイテム |

## 6. 死亡とペナルティ
HP が 0 になった場合、キャラクターは死亡します。
デスペナルティの詳細は、管理者が設定したルールに基づきます。
詳細は [機能仕様書](Functional-Specification.md) の「4. デスペナルティの設定」を参照してください。

## 7. 実装案

### 7.1 モジュール間連携
戦闘発生時の基本的なデータフローは以下の通りです。

1. **PlayerOperations**: クライアントからの攻撃コマンドを受信。
2. **PlayerOperations -> Dungeon**: 攻撃範囲内にターゲットが存在するか確認。
3. **PlayerOperations -> Objects**: 装備品（武器・防具）の性能データを取得。
4. **PlayerOperations**: ダメージ計算を実行。
5. **PlayerOperations -> BookOfAdventure**: プレイヤー（またはターゲット）の HP 更新を要求。
6. **PlayerOperations -> Display**: 戦闘ログおよび演出データを送信。

### 7.2 拡張性
- **属性（火、水、風、土など）**: 武器やモンスターに属性を付与し、相性によるダメージ増減を導入予定。
- **部位破壊**: 特定の強力なモンスターに対し、特定の部位を攻撃して無力化する要素の検討。
